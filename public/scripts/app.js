class GameWebApp {
    constructor() {
        this.currentPage = 'home';
        this.init();
    }

    async init() {
        try {
            console.log('üöÄ Starting app initialization...');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
            this.showLoadingScreen();
            
            // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫—É –∑–∞–≥—Ä—É–∑–∫–∏
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram
            await this.initTelegram();
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userData = await this.getUserData();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            this.updateUI(userData);
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
            this.setupNavigation();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            setTimeout(() => {
                this.hideLoadingScreen();
                console.log('‚úÖ App initialized successfully');
            }, 2000);
            
        } catch (error) {
            console.error('‚ùå App initialization failed:', error);
            this.showError(error.message);
            this.hideLoadingScreen();
        }
    }

    async initTelegram() {
        return new Promise((resolve) => {
            console.log('Initializing Telegram WebApp...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ Telegram WebApp
            if (typeof Telegram === 'undefined' || !Telegram.WebApp) {
                throw new Error('Telegram WebApp not available');
            }
            
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            
            // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é Telegram
            setTimeout(() => {
                console.log('Telegram WebApp ready');
                resolve();
            }, 300);
        });
    }

    async getUserData() {
        console.log('Getting user data...');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ Telegram
        if (!Telegram.WebApp.initDataUnsafe || !Telegram.WebApp.initDataUnsafe.user) {
            console.warn('No Telegram user data, using fallback');
            return this.getFallbackUserData();
        }
        
        const tgUser = Telegram.WebApp.initDataUnsafe.user;
        console.log('Telegram user:', tgUser);
        
        return {
            id: tgUser.id,
            firstName: tgUser.first_name,
            lastName: tgUser.last_name,
            username: tgUser.username,
            photoUrl: tgUser.photo_url,
            languageCode: tgUser.language_code
        };
    }

    getFallbackUserData() {
        // –ó–∞–≥–ª—É—à–∫–∞ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ Telegram –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã
        return {
            id: Math.random().toString(36).substr(2, 9),
            firstName: '–ì–æ—Å—Ç—å',
            lastName: '',
            username: 'guest',
            photoUrl: null
        };
    }

    updateUI(userData) {
        console.log('Updating UI with user data:', userData);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        this.updateProfile(userData);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å—ã
        this.updateBalances();
        
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        this.showPage('home');
    }

    updateProfile(userData) {
        const userNameElement = document.getElementById('user-name');
        const userAvatarElement = document.getElementById('user-avatar');
        
        if (userNameElement) {
            const name = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
            userNameElement.textContent = name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        }
        
        if (userAvatarElement) {
            if (userData.photoUrl) {
                userAvatarElement.src = userData.photoUrl;
                userAvatarElement.onerror = () => this.setFallbackAvatar(userData);
            } else {
                this.setFallbackAvatar(userData);
            }
        }
    }

    setFallbackAvatar(userData) {
        const userAvatarElement = document.getElementById('user-avatar');
        if (!userAvatarElement) return;
        
        const first = userData.firstName ? userData.firstName[0] : '';
        const last = userData.lastName ? userData.lastName[0] : '';
        const initials = (first + last).toUpperCase() || 'U';
        
        const colors = ['#00f3ff', '#ff00ff', '#bd00ff'];
        const color = colors[initials.charCodeAt(0) % colors.length];
        
        userAvatarElement.src = `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80"><rect width="80" height="80" fill="${color}20" rx="40"/><text x="40" y="45" text-anchor="middle" fill="${color}" font-family="Arial" font-size="30" font-weight="bold">${initials}</text></svg>`;
    }

    updateBalances() {
        // –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –±–∞–ª–∞–Ω—Å–æ–≤
        const tonBalanceElement = document.getElementById('ton-balance');
        const starsBalanceElement = document.getElementById('stars-balance');
        
        if (tonBalanceElement) {
            tonBalanceElement.textContent = '0 TON';
        }
        if (starsBalanceElement) {
            starsBalanceElement.textContent = '0 Stars';
        }
    }

    setupNavigation() {
        console.log('Setting up navigation...');
        
        const navButtons = document.querySelectorAll('.nav-btn');
        if (!navButtons.length) {
            console.warn('No navigation buttons found');
            return;
        }
        
        navButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const page = e.currentTarget.getAttribute('data-page');
                console.log('Navigating to:', page);
                this.showPage(page);
            });
        });
        
        // –ü—Ä–æ—Å—Ç—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        this.setupBasicButton('deposit-ton', '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ TON');
        this.setupBasicButton('withdraw-ton', '–í—ã–≤–æ–¥ TON');
        this.setupBasicButton('deposit-stars', '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ Stars');
        this.setupBasicButton('withdraw-stars', '–í—ã–≤–æ–¥ Stars');
        this.setupBasicButton('request-gift', '–ü–æ–¥–∞—Ä–æ–∫');
        this.setupBasicButton('place-bet', '–°—Ç–∞–≤–∫–∞');
        this.setupBasicButton('add-bet', '–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–≤–∫—É');
    }

    setupBasicButton(buttonId, message) {
        const button = document.getElementById(buttonId);
        if (button) {
            button.addEventListener('click', () => {
                Telegram.WebApp.showPopup({
                    title: message,
                    message: '–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ',
                    buttons: [{ type: 'ok' }]
                });
            });
        }
    }

    showPage(pageId) {
        console.log('Showing page:', pageId);
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const pages = document.querySelectorAll('.page');
        pages.forEach(page => {
            page.classList.remove('active');
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        const targetPage = document.getElementById(`${pageId}-page`);
        if (targetPage) {
            targetPage.classList.add('active');
            this.currentPage = pageId;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        const navButtons = document.querySelectorAll('.nav-btn');
        navButtons.forEach(btn => {
            btn.classList.remove('active');
        });
        
        const activeBtn = document.querySelector(`[data-page="${pageId}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
    }

    showLoadingScreen() {
        console.log('Showing loading screen...');
        const loadingScreen = document.getElementById('loading-screen');
        const app = document.getElementById('app');
        
        if (loadingScreen) {
            loadingScreen.style.display = 'flex';
            loadingScreen.classList.remove('hidden');
        }
        if (app) {
            app.style.display = 'none';
            app.classList.add('hidden');
        }
    }

    hideLoadingScreen() {
        console.log('Hiding loading screen...');
        const loadingScreen = document.getElementById('loading-screen');
        const app = document.getElementById('app');
        
        if (loadingScreen) {
            loadingScreen.style.display = 'none';
            loadingScreen.classList.add('hidden');
        }
        if (app) {
            app.style.display = 'block';
            app.classList.remove('hidden');
        }
    }

    showError(message) {
        console.error('Showing error:', message);
        
        // –ü—Ä–æ—Å—Ç–æ–π alert –≤–º–µ—Å—Ç–æ —Å–ª–æ–∂–Ω—ã—Ö popup
        alert(`–û—à–∏–±–∫–∞: ${message}\n\n–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ.`);
    }
}

// –ê–≤–∞—Ä–∏–π–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
window.addEventListener('error', function(event) {
    console.error('Global error:', event.error);
    
    // –ü—ã—Ç–∞–µ–º—Å—è —Å–∫—Ä—ã—Ç—å —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
    const loadingScreen = document.getElementById('loading-screen');
    const app = document.getElementById('app');
    
    if (loadingScreen) {
        loadingScreen.style.display = 'none';
    }
    if (app) {
        app.style.display = 'block';
    }
});

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∫–æ–≥–¥–∞ DOM –≥–æ—Ç–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded and parsed');
    
    // –î–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
    setTimeout(() => {
        window.app = new GameWebApp();
    }, 100);
});

// –†–µ–∑–µ—Ä–≤–Ω—ã–π –∑–∞–ø—É—Å–∫ –µ—Å–ª–∏ DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(() => {
        window.app = new GameWebApp();
    }, 100);
}
